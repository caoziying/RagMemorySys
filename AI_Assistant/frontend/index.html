<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MNEMO Â· ä¸ªæ€§åŒ– AI åŠ©æ‰‹</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300&display=swap" rel="stylesheet">
<style>
/* â”€â”€ Reset & Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:        #0d0e11;
  --bg2:       #13141a;
  --bg3:       #1a1c24;
  --border:    #252730;
  --border2:   #2e3040;
  --text:      #e8e9f0;
  --text2:     #8b8fa8;
  --text3:     #555870;
  --accent:    #e8b84b;
  --accent2:   #c49630;
  --accent-bg: rgba(232,184,75,0.08);
  --accent-bg2:rgba(232,184,75,0.15);
  --user-bg:   #1e2030;
  --ai-bg:     #13141a;
  --danger:    #e05a5a;
  --green:     #5abb8a;
  --r-sm:      6px;
  --r-md:      10px;
  --r-lg:      16px;
  --sidebar-w: 260px;
  --trans:     0.18s cubic-bezier(.4,0,.2,1);
}

html, body { height: 100%; font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }

/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app { display: flex; height: 100vh; }

/* â”€â”€ Auth Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#auth-screen {
  position: fixed; inset: 0; z-index: 100;
  display: flex; align-items: center; justify-content: center;
  background: var(--bg);
}
.auth-card {
  width: 380px;
  background: var(--bg2);
  border: 1px solid var(--border2);
  border-radius: var(--r-lg);
  padding: 44px 40px;
  box-shadow: 0 32px 64px rgba(0,0,0,.6);
  animation: slideUp .35s cubic-bezier(.4,0,.2,1);
}
.auth-logo {
  font-family: 'DM Serif Display', serif;
  font-size: 2.2rem;
  color: var(--accent);
  letter-spacing: -.02em;
  margin-bottom: 4px;
}
.auth-tagline { font-size: .8rem; color: var(--text3); letter-spacing: .06em; text-transform: uppercase; margin-bottom: 36px; }
.auth-tabs { display: flex; gap: 0; margin-bottom: 28px; border: 1px solid var(--border); border-radius: var(--r-sm); padding: 3px; }
.auth-tab {
  flex: 1; padding: 8px; text-align: center; font-size: .85rem; font-weight: 500;
  border-radius: 4px; cursor: pointer; color: var(--text2); transition: var(--trans);
}
.auth-tab.active { background: var(--accent); color: #000; }
.form-group { margin-bottom: 16px; }
.form-label { display: block; font-size: .78rem; font-weight: 500; color: var(--text2); margin-bottom: 6px; letter-spacing: .04em; text-transform: uppercase; }
.form-input {
  width: 100%; padding: 11px 14px; background: var(--bg3);
  border: 1px solid var(--border2); border-radius: var(--r-sm);
  color: var(--text); font-family: inherit; font-size: .9rem;
  outline: none; transition: var(--trans);
}
.form-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-bg); }
.form-input::placeholder { color: var(--text3); }
.btn-primary {
  width: 100%; padding: 12px; background: var(--accent); border: none;
  border-radius: var(--r-sm); color: #000; font-family: inherit;
  font-size: .9rem; font-weight: 600; cursor: pointer;
  margin-top: 4px; transition: var(--trans); letter-spacing: .02em;
}
.btn-primary:hover { background: #f5c85a; transform: translateY(-1px); box-shadow: 0 6px 20px rgba(232,184,75,.3); }
.btn-primary:active { transform: translateY(0); }
.auth-err { font-size: .82rem; color: var(--danger); margin-top: 10px; text-align: center; min-height: 18px; }

/* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar {
  width: var(--sidebar-w); flex-shrink: 0;
  background: var(--bg2); border-right: 1px solid var(--border);
  display: flex; flex-direction: column; overflow: hidden;
}
.sidebar-header {
  padding: 20px 16px 16px;
  border-bottom: 1px solid var(--border);
}
.logo { font-family: 'DM Serif Display', serif; font-size: 1.5rem; color: var(--accent); letter-spacing: -.02em; }
.logo span { font-style: italic; }
.user-chip {
  display: flex; align-items: center; gap: 8px; margin-top: 12px;
  padding: 7px 10px; background: var(--bg3); border-radius: var(--r-sm);
  cursor: pointer; transition: var(--trans);
}
.user-chip:hover { border-color: var(--border2); background: var(--border); }
.user-avatar {
  width: 28px; height: 28px; border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), #c49630);
  display: flex; align-items: center; justify-content: center;
  font-size: .75rem; font-weight: 700; color: #000; flex-shrink: 0;
}
.user-name { font-size: .82rem; font-weight: 500; color: var(--text); flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.user-logout { font-size: .7rem; color: var(--text3); cursor: pointer; }
.user-logout:hover { color: var(--danger); }

.new-chat-btn {
  margin: 12px; padding: 10px 14px; background: transparent;
  border: 1px dashed var(--border2); border-radius: var(--r-sm);
  color: var(--text2); font-family: inherit; font-size: .83rem;
  cursor: pointer; display: flex; align-items: center; gap: 8px;
  transition: var(--trans);
}
.new-chat-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-bg); }

.sidebar-section-label {
  padding: 8px 16px 4px; font-size: .68rem; font-weight: 600;
  color: var(--text3); letter-spacing: .08em; text-transform: uppercase;
}

.conv-list { flex: 1; overflow-y: auto; padding: 0 8px 12px; }
.conv-list::-webkit-scrollbar { width: 4px; }
.conv-list::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

.conv-item {
  display: flex; align-items: center; gap: 6px;
  padding: 9px 10px; border-radius: var(--r-sm); cursor: pointer;
  transition: var(--trans); position: relative; group: true;
}
.conv-item:hover { background: var(--bg3); }
.conv-item.active { background: var(--accent-bg2); }
.conv-item.active .conv-title { color: var(--accent); }
.conv-icon { font-size: .85rem; opacity: .5; flex-shrink: 0; }
.conv-title {
  flex: 1; font-size: .82rem; color: var(--text2); overflow: hidden;
  text-overflow: ellipsis; white-space: nowrap; transition: var(--trans);
}
.conv-item:hover .conv-title { color: var(--text); }
.conv-actions { display: none; gap: 2px; }
.conv-item:hover .conv-actions { display: flex; }
.conv-act-btn {
  width: 22px; height: 22px; border-radius: 4px; background: transparent;
  border: none; cursor: pointer; display: flex; align-items: center;
  justify-content: center; font-size: .75rem; color: var(--text3);
  transition: var(--trans);
}
.conv-act-btn:hover { background: var(--border2); color: var(--text); }
.conv-act-btn.del:hover { color: var(--danger); }

/* â”€â”€ Main Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#main { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; }

/* â”€â”€ Chat Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chat-header {
  padding: 16px 24px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 12px;
  background: var(--bg); flex-shrink: 0;
}
.chat-header-title { font-size: .95rem; font-weight: 500; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.memory-badge {
  font-size: .7rem; padding: 3px 8px; border-radius: 20px;
  background: var(--accent-bg); color: var(--accent);
  border: 1px solid rgba(232,184,75,.2); letter-spacing: .04em;
  font-family: 'DM Mono', monospace;
}

/* â”€â”€ Messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#messages {
  flex: 1; overflow-y: auto; padding: 24px;
  display: flex; flex-direction: column; gap: 20px;
}
#messages::-webkit-scrollbar { width: 6px; }
#messages::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

.empty-state {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 16px;
  color: var(--text3); text-align: center;
}
.empty-icon { font-size: 3rem; opacity: .3; }
.empty-title { font-family: 'DM Serif Display', serif; font-size: 1.6rem; color: var(--text2); }
.empty-sub { font-size: .85rem; max-width: 300px; line-height: 1.6; }
.suggestion-chips { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 8px; }
.chip {
  padding: 6px 14px; border: 1px solid var(--border2); border-radius: 20px;
  font-size: .8rem; color: var(--text2); cursor: pointer; transition: var(--trans);
  background: var(--bg2);
}
.chip:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-bg); }

.message { display: flex; gap: 12px; max-width: 820px; animation: msgIn .25s ease; }
.message.user { flex-direction: row-reverse; align-self: flex-end; }
.msg-avatar {
  width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center; font-size: .8rem;
  font-weight: 700; margin-top: 2px;
}
.message.user .msg-avatar { background: linear-gradient(135deg, var(--accent), #c49630); color: #000; }
.message.assistant .msg-avatar { background: var(--bg3); border: 1px solid var(--border2); color: var(--text2); }
.msg-body { flex: 1; min-width: 0; }
.msg-meta { font-size: .7rem; color: var(--text3); margin-bottom: 5px; font-family: 'DM Mono', monospace; }
.message.user .msg-meta { text-align: right; }
.msg-bubble {
  padding: 13px 17px; border-radius: var(--r-md); line-height: 1.7;
  font-size: .9rem; word-break: break-word;
}
.message.user .msg-bubble { background: var(--user-bg); border: 1px solid var(--border2); border-top-right-radius: 3px; }
.message.assistant .msg-bubble { background: var(--ai-bg); border: 1px solid var(--border); border-top-left-radius: 3px; }

/* Markdown-like content rendering */
.msg-bubble p { margin-bottom: .7em; }
.msg-bubble p:last-child { margin-bottom: 0; }
.msg-bubble code {
  font-family: 'DM Mono', monospace; font-size: .82em;
  background: var(--bg3); padding: 2px 6px; border-radius: 4px;
  border: 1px solid var(--border);
}
.msg-bubble pre {
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: var(--r-sm); padding: 14px; overflow-x: auto;
  margin: .8em 0; font-family: 'DM Mono', monospace; font-size: .82em;
}
.msg-bubble pre code { background: none; border: none; padding: 0; }
.msg-bubble strong { color: var(--text); font-weight: 600; }
.msg-bubble h1, .msg-bubble h2, .msg-bubble h3 {
  font-family: 'DM Serif Display', serif; color: var(--text); margin: .8em 0 .4em;
}
.msg-bubble ul, .msg-bubble ol { padding-left: 1.4em; margin: .5em 0; }
.msg-bubble li { margin-bottom: .3em; }
.msg-bubble blockquote {
  border-left: 3px solid var(--accent); padding-left: 12px;
  color: var(--text2); margin: .6em 0; font-style: italic;
}

.typing-indicator { display: flex; gap: 5px; align-items: center; padding: 4px 0; }
.typing-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--text3); animation: bounce .9s infinite; }
.typing-dot:nth-child(2) { animation-delay: .15s; }
.typing-dot:nth-child(3) { animation-delay: .3s; }

/* â”€â”€ Input Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.input-area {
  padding: 16px 24px 20px; border-top: 1px solid var(--border);
  background: var(--bg); flex-shrink: 0;
}
.input-box {
  display: flex; gap: 10px; align-items: flex-end;
  background: var(--bg2); border: 1px solid var(--border2);
  border-radius: var(--r-lg); padding: 10px 12px;
  transition: var(--trans);
}
.input-box:focus-within { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-bg); }
#msg-input {
  flex: 1; background: none; border: none; outline: none;
  color: var(--text); font-family: inherit; font-size: .9rem;
  resize: none; max-height: 150px; line-height: 1.5;
  min-height: 24px; overflow-y: auto;
}
#msg-input::placeholder { color: var(--text3); }
#msg-input::-webkit-scrollbar { width: 4px; }
#msg-input::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
.send-btn {
  width: 36px; height: 36px; background: var(--accent); border: none;
  border-radius: 8px; cursor: pointer; display: flex; align-items: center;
  justify-content: center; flex-shrink: 0; transition: var(--trans);
  color: #000; font-size: 1rem;
}
.send-btn:hover:not(:disabled) { background: #f5c85a; transform: scale(1.05); }
.send-btn:disabled { background: var(--border2); cursor: not-allowed; opacity: .5; }
.input-hint { font-size: .72rem; color: var(--text3); margin-top: 8px; text-align: center; }

/* â”€â”€ Rename Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,.7);
  display: flex; align-items: center; justify-content: center;
  z-index: 200; backdrop-filter: blur(4px);
}
.modal {
  background: var(--bg2); border: 1px solid var(--border2);
  border-radius: var(--r-lg); padding: 28px; width: 360px;
  box-shadow: 0 24px 48px rgba(0,0,0,.6);
  animation: slideUp .2s ease;
}
.modal-title { font-family: 'DM Serif Display', serif; font-size: 1.2rem; margin-bottom: 16px; }
.modal-actions { display: flex; gap: 10px; margin-top: 20px; }
.btn-ghost {
  flex: 1; padding: 10px; border: 1px solid var(--border2); border-radius: var(--r-sm);
  background: none; color: var(--text2); font-family: inherit;
  font-size: .87rem; cursor: pointer; transition: var(--trans);
}
.btn-ghost:hover { border-color: var(--border2); background: var(--bg3); color: var(--text); }
.btn-accent {
  flex: 1; padding: 10px; background: var(--accent); border: none;
  border-radius: var(--r-sm); color: #000; font-family: inherit;
  font-size: .87rem; font-weight: 600; cursor: pointer; transition: var(--trans);
}
.btn-accent:hover { background: #f5c85a; }

/* â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes slideUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
@keyframes msgIn   { from { opacity: 0; transform: translateY(8px); }  to { opacity: 1; transform: translateY(0); } }
@keyframes bounce  { 0%,80%,100% { transform: scale(0.8); opacity:.4; } 40% { transform: scale(1); opacity:1; } }

/* â”€â”€ No conv selected â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.no-conv {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 12px;
  color: var(--text3);
}
.no-conv-icon { font-size: 3.5rem; opacity: .15; }
.no-conv-text { font-size: .9rem; }
</style>
</head>
<body>

<!-- Auth Screen -->
<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-logo">MN<span>E</span>MO</div>
    <div class="auth-tagline">Personalized AI Â· Persistent Memory</div>
    <div class="auth-tabs">
      <div class="auth-tab active" onclick="switchAuthTab('login')">ç™»å½•</div>
      <div class="auth-tab" onclick="switchAuthTab('register')">æ³¨å†Œ</div>
    </div>
    <div class="form-group">
      <label class="form-label">ç”¨æˆ·å</label>
      <input class="form-input" id="auth-username" type="text" placeholder="è¾“å…¥ç”¨æˆ·å" autocomplete="username">
    </div>
    <div class="form-group">
      <label class="form-label">å¯†ç </label>
      <input class="form-input" id="auth-password" type="password" placeholder="è¾“å…¥å¯†ç " autocomplete="current-password">
    </div>
    <div class="auth-err" id="auth-err"></div>
    <button class="btn-primary" id="auth-btn" onclick="doAuth()">ç™»å½•</button>
  </div>
</div>

<!-- Main App -->
<div id="app" style="display:none">
  <!-- Sidebar -->
  <div id="sidebar">
    <div class="sidebar-header">
      <div class="logo">MN<span>E</span>MO</div>
      <div class="user-chip" id="user-chip">
        <div class="user-avatar" id="user-avatar">?</div>
        <div class="user-name" id="user-display-name">ç”¨æˆ·</div>
        <div class="user-logout" onclick="logout()" title="é€€å‡ºç™»å½•">â»</div>
      </div>
    </div>
    <button class="new-chat-btn" onclick="newConversation()">
      <span>ï¼‹</span> æ–°å»ºå¯¹è¯
    </button>
    <div class="sidebar-section-label">å¯¹è¯å†å²</div>
    <div class="conv-list" id="conv-list"></div>
  </div>

  <!-- Main -->
  <div id="main">
    <!-- No conversation selected -->
    <div class="no-conv" id="no-conv-view">
      <div class="no-conv-icon">ğŸ’¬</div>
      <div class="no-conv-text">é€‰æ‹©æˆ–æ–°å»ºä¸€ä¸ªå¯¹è¯å¼€å§‹èŠå¤©</div>
    </div>

    <!-- Chat view -->
    <div id="chat-view" style="display:none; flex:1; flex-direction:column; overflow:hidden;">
      <div class="chat-header">
        <div class="chat-header-title" id="chat-title">å¯¹è¯</div>
        <div class="memory-badge">âš¡ RAG è®°å¿†å¢å¼º</div>
      </div>
      <div id="messages"></div>
      <div class="input-area">
        <div class="input-box">
          <textarea id="msg-input" placeholder="å‘æ¶ˆæ¯ç»™ MNEMOâ€¦" rows="1"></textarea>
          <button class="send-btn" id="send-btn" onclick="sendMessage()">â¤</button>
        </div>
        <div class="input-hint">æŒ‰ Enter å‘é€ Â· Shift+Enter æ¢è¡Œ</div>
      </div>
    </div>
  </div>
</div>

<!-- Rename Modal -->
<div class="modal-overlay" id="rename-modal" style="display:none" onclick="closeRenameModal(event)">
  <div class="modal">
    <div class="modal-title">é‡å‘½åå¯¹è¯</div>
    <div class="form-group" style="margin-bottom:0">
      <label class="form-label">å¯¹è¯åç§°</label>
      <input class="form-input" id="rename-input" type="text" placeholder="è¾“å…¥æ–°åç§°">
    </div>
    <div class="modal-actions">
      <button class="btn-ghost" onclick="closeRenameModal()">å–æ¶ˆ</button>
      <button class="btn-accent" onclick="confirmRename()">ç¡®è®¤</button>
    </div>
  </div>
</div>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API = window.BACKEND_URL || 'http://localhost:8001';

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let token = localStorage.getItem('token') || '';
let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
let conversations = [];
let activeConvId = null;
let renameTargetId = null;
let isStreaming = false;

// â”€â”€ Auth Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let authMode = 'login';
function switchAuthTab(mode) {
  authMode = mode;
  document.querySelectorAll('.auth-tab').forEach((t,i) => {
    t.classList.toggle('active', (i===0 && mode==='login') || (i===1 && mode==='register'));
  });
  document.getElementById('auth-btn').textContent = mode === 'login' ? 'ç™»å½•' : 'æ³¨å†Œ';
  document.getElementById('auth-err').textContent = '';
}

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doAuth() {
  const username = document.getElementById('auth-username').value.trim();
  const password = document.getElementById('auth-password').value;
  const errEl = document.getElementById('auth-err');
  errEl.textContent = '';

  if (!username || !password) { errEl.textContent = 'è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç '; return; }

  const endpoint = authMode === 'login' ? '/auth/login' : '/auth/register';
  try {
    const res = await fetch(API + endpoint, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });
    const data = await res.json();
    if (!res.ok) { errEl.textContent = data.detail || 'æ“ä½œå¤±è´¥'; return; }

    token = data.token;
    currentUser = { id: data.user_id, username: data.username };
    localStorage.setItem('token', token);
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    enterApp();
  } catch(e) {
    errEl.textContent = 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦å¯åŠ¨';
  }
}

document.getElementById('auth-password').addEventListener('keydown', e => {
  if (e.key === 'Enter') doAuth();
});

// â”€â”€ App Entry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function enterApp() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  updateUserChip();
  loadConversations();
}

function updateUserChip() {
  if (!currentUser) return;
  const initial = currentUser.username[0].toUpperCase();
  document.getElementById('user-avatar').textContent = initial;
  document.getElementById('user-display-name').textContent = currentUser.username;
}

function logout() {
  token = ''; currentUser = null; activeConvId = null;
  localStorage.removeItem('token'); localStorage.removeItem('currentUser');
  document.getElementById('app').style.display = 'none';
  document.getElementById('auth-screen').style.display = 'flex';
  document.getElementById('auth-username').value = '';
  document.getElementById('auth-password').value = '';
  document.getElementById('conv-list').innerHTML = '';
}

// â”€â”€ Conversations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadConversations() {
  const res = await apiFetch('/conversations');
  if (!res) return;
  conversations = await res.json();
  renderConvList();
}

function renderConvList() {
  const el = document.getElementById('conv-list');
  el.innerHTML = '';
  if (conversations.length === 0) {
    el.innerHTML = '<div style="padding:12px 16px;font-size:.78rem;color:var(--text3)">æš‚æ— å¯¹è¯ï¼Œç‚¹å‡»ä¸Šæ–¹æ–°å»º</div>';
    return;
  }
  conversations.forEach(c => {
    const div = document.createElement('div');
    div.className = 'conv-item' + (c.id === activeConvId ? ' active' : '');
    div.dataset.id = c.id;
    div.innerHTML = `
      <span class="conv-icon">ğŸ’¬</span>
      <span class="conv-title" title="${esc(c.title)}">${esc(c.title)}</span>
      <div class="conv-actions">
        <button class="conv-act-btn" title="é‡å‘½å" onclick="openRenameModal('${c.id}','${esc(c.title)}',event)">âœ</button>
        <button class="conv-act-btn del" title="åˆ é™¤" onclick="deleteConversation('${c.id}',event)">âœ•</button>
      </div>`;
    div.addEventListener('click', () => selectConversation(c.id));
    el.appendChild(div);
  });
}

async function newConversation() {
  const res = await apiFetch('/conversations', 'POST');
  if (!res) return;
  const conv = await res.json();
  conversations.unshift(conv);
  renderConvList();
  selectConversation(conv.id);
}

async function deleteConversation(id, e) {
  e.stopPropagation();
  if (!confirm('ç¡®è®¤åˆ é™¤æ­¤å¯¹è¯ï¼Ÿ')) return;
  const res = await apiFetch('/conversations/' + id, 'DELETE');
  if (!res && res !== null) return; // null means 204
  conversations = conversations.filter(c => c.id !== id);
  if (activeConvId === id) {
    activeConvId = null;
    showNoConv();
  }
  renderConvList();
}

// â”€â”€ Rename Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openRenameModal(id, title, e) {
  e.stopPropagation();
  renameTargetId = id;
  document.getElementById('rename-input').value = title;
  document.getElementById('rename-modal').style.display = 'flex';
  setTimeout(() => document.getElementById('rename-input').select(), 50);
}
function closeRenameModal(e) {
  if (e && e.target !== document.getElementById('rename-modal')) return;
  document.getElementById('rename-modal').style.display = 'none';
  renameTargetId = null;
}
document.getElementById('rename-input').addEventListener('keydown', e => { if(e.key==='Enter') confirmRename(); });
async function confirmRename() {
  const title = document.getElementById('rename-input').value.trim();
  if (!title || !renameTargetId) return;
  const res = await apiFetch('/conversations/' + renameTargetId, 'PATCH', { title });
  if (!res) return;
  const data = await res.json();
  const conv = conversations.find(c => c.id === renameTargetId);
  if (conv) conv.title = data.title;
  if (activeConvId === renameTargetId) document.getElementById('chat-title').textContent = data.title;
  renderConvList();
  document.getElementById('rename-modal').style.display = 'none';
  renameTargetId = null;
}

// â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function selectConversation(id) {
  activeConvId = id;
  renderConvList();
  const conv = conversations.find(c => c.id === id);
  document.getElementById('chat-title').textContent = conv?.title || 'å¯¹è¯';
  document.getElementById('no-conv-view').style.display = 'none';
  const chatView = document.getElementById('chat-view');
  chatView.style.display = 'flex';

  // Load messages
  const res = await apiFetch('/conversations/' + id + '/messages');
  if (!res) return;
  const msgs = await res.json();
  const container = document.getElementById('messages');
  container.innerHTML = '';

  if (msgs.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">ğŸ§ </div>
        <div class="empty-title">å¸¦è®°å¿†çš„ AI åŠ©æ‰‹</div>
        <div class="empty-sub">æˆ‘è®°å¾—ä½ ä¹‹å‰è¯´è¿‡çš„ä¸€åˆ‡ã€‚å°½ç®¡é—®æˆ‘å§ã€‚</div>
        <div class="suggestion-chips">
          <div class="chip" onclick="fillInput('ä½ è¿˜è®°å¾—æˆ‘å—ï¼Ÿ')">ä½ è¿˜è®°å¾—æˆ‘å—ï¼Ÿ</div>
          <div class="chip" onclick="fillInput('æˆ‘ä¹‹å‰åœ¨åšä»€ä¹ˆé¡¹ç›®ï¼Ÿ')">æˆ‘ä¹‹å‰åœ¨åšä»€ä¹ˆé¡¹ç›®ï¼Ÿ</div>
          <div class="chip" onclick="fillInput('å¸®æˆ‘æ€»ç»“ä¸€ä¸‹æˆ‘ä»¬çš„å¯¹è¯')">æ€»ç»“æˆ‘ä»¬çš„å¯¹è¯</div>
        </div>
      </div>`;
  } else {
    msgs.forEach(m => appendMessage(m.role, m.content, false));
    scrollToBottom();
  }
}

function showNoConv() {
  document.getElementById('no-conv-view').style.display = 'flex';
  document.getElementById('chat-view').style.display = 'none';
}

function fillInput(text) {
  document.getElementById('msg-input').value = text;
  document.getElementById('msg-input').focus();
}

function appendMessage(role, content, animate=true) {
  const container = document.getElementById('messages');
  // Remove empty state if present
  const empty = container.querySelector('.empty-state');
  if (empty) empty.remove();

  const userInitial = currentUser ? currentUser.username[0].toUpperCase() : 'U';
  const time = new Date().toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'});
  const isUser = role === 'user';

  const div = document.createElement('div');
  div.className = `message ${role}`;
  if (!animate) div.style.animation = 'none';

  div.innerHTML = `
    <div class="msg-avatar">${isUser ? userInitial : 'ğŸ§ '}</div>
    <div class="msg-body">
      <div class="msg-meta">${isUser ? (currentUser?.username || 'ä½ ') : 'MNEMO'} Â· ${time}</div>
      <div class="msg-bubble">${renderMarkdown(content)}</div>
    </div>`;

  container.appendChild(div);
  scrollToBottom();
  return div;
}

function appendTypingIndicator() {
  const container = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'message assistant';
  div.id = 'typing-indicator';
  div.innerHTML = `
    <div class="msg-avatar">ğŸ§ </div>
    <div class="msg-body">
      <div class="msg-meta">MNEMO Â· æ­£åœ¨æ€è€ƒ...</div>
      <div class="msg-bubble">
        <div class="typing-indicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      </div>
    </div>`;
  container.appendChild(div);
  scrollToBottom();
  return div;
}

async function sendMessage() {
  if (isStreaming || !activeConvId) return;
  const input = document.getElementById('msg-input');
  const content = input.value.trim();
  if (!content) return;

  input.value = '';
  input.style.height = 'auto';
  isStreaming = true;
  document.getElementById('send-btn').disabled = true;

  appendMessage('user', content);

  // Show typing indicator
  const typingEl = appendTypingIndicator();

  try {
    const res = await fetch(`${API}/conversations/${activeConvId}/chat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
      body: JSON.stringify({ content })
    });

    if (!res.ok) { throw new Error('è¯·æ±‚å¤±è´¥'); }

    // Remove typing indicator, create streaming bubble
    typingEl.remove();
    const time = new Date().toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'});
    const container = document.getElementById('messages');
    const msgDiv = document.createElement('div');
    msgDiv.className = 'message assistant';
    msgDiv.innerHTML = `
      <div class="msg-avatar">ğŸ§ </div>
      <div class="msg-body">
        <div class="msg-meta">MNEMO Â· ${time}</div>
        <div class="msg-bubble" id="stream-bubble"></div>
      </div>`;
    container.appendChild(msgDiv);

    const bubble = document.getElementById('stream-bubble');
    let fullText = '';

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n\n');
      buffer = lines.pop() || '';

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const raw = line.slice(6);
          if (raw === '[DONE]') continue;
          try {
            const data = JSON.parse(raw);
            if (data.content) {
              fullText += data.content;
              bubble.innerHTML = renderMarkdown(fullText);
              scrollToBottom();
            }
          } catch(e) {}
        }
      }
    }

    // Update conversation title if changed
    await loadConversations();

  } catch(e) {
    typingEl?.remove();
    appendMessage('assistant', 'âš ï¸ è¯·æ±‚å¤±è´¥ï¼š' + e.message);
  }

  isStreaming = false;
  document.getElementById('send-btn').disabled = false;
  document.getElementById('msg-input').focus();
}

// â”€â”€ Input auto-resize & hotkey â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const msgInput = document.getElementById('msg-input');
msgInput.addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 150) + 'px';
});
msgInput.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});

// â”€â”€ Markdown Renderer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMarkdown(text) {
  // Basic markdown support
  let html = text
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    // Code blocks
    .replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) =>
      `<pre><code class="lang-${lang}">${code.trim()}</code></pre>`)
    // Inline code
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    // Bold
    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
    // Italic
    .replace(/\*([^*]+)\*/g, '<em>$1</em>')
    // Headings
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
    // Blockquote
    .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
    // Unordered list
    .replace(/^[*\-] (.+)$/gm, '<li>$1</li>')
    .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
    // Ordered list
    .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
    // Line breaks to paragraphs
    .replace(/\n\n/g, '</p><p>')
    .replace(/\n/g, '<br>');

  // Wrap in paragraph if no block elements
  if (!html.match(/^<[hup]/)) html = `<p>${html}</p>`;
  return html;
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function scrollToBottom() {
  const el = document.getElementById('messages');
  el.scrollTop = el.scrollHeight;
}

async function apiFetch(path, method='GET', body=null) {
  const opts = { method, headers: { 'Authorization': 'Bearer ' + token } };
  if (body) { opts.headers['Content-Type'] = 'application/json'; opts.body = JSON.stringify(body); }
  try {
    const res = await fetch(API + path, opts);
    if (res.status === 204) return null;
    if (res.status === 401) { logout(); return; }
    return res;
  } catch(e) { console.error(e); return; }
}

// â”€â”€ Auto-login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if (token && currentUser) { enterApp(); }
</script>
</body>
</html>
